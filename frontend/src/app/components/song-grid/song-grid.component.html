<!-- Şarkı listesi -->
<div class="song-grid">
  <!-- Yükleniyor -->
  <div *ngIf="loading()" class="loading-indicator">
    <span class="material-icons spin">refresh</span> Playlist içeriği yükleniyor...
  </div>

  <!-- Benzerlik Skoru Filtresi -->
  <div class="similarity-filter-container" *ngIf="songs && songs.length > 0">
    <div class="filter-header">
      <h3>Benzerlik Skoru Filtresi</h3>
      <button class="filter-toggle-btn" 
              [class.active]="showSimilarityFilter"
              (click)="toggleSimilarityFilter()">
        <span class="material-icons">{{ showSimilarityFilter ? 'filter_alt' : 'filter_alt_off' }}</span>
        {{ showSimilarityFilter ? 'Filtreyi Kapat' : 'Filtreyi Aç' }}
      </button>
    </div>
    
    <div class="filter-controls" *ngIf="showSimilarityFilter">
      <div class="selection-info" *ngIf="getSelectedSongsCount() > 0">
        <div class="selection-count">
          <span class="material-icons">check_circle</span>
          <span>{{ getSelectedSongsCount() }} şarkı filtrelendi ({{ (similarityThreshold * 100) | number:'1.0-0' }}% ve üzeri)</span>
        </div>
      </div>
      
      <div class="slider-container">
        <label class="slider-label">
          Minimum Benzerlik Skoru: {{ (similarityThreshold * 100) | number:'1.0-0' }}%
        </label>
        <input type="range" 
               min="0" 
               max="1" 
               step="0.05"
               [value]="similarityThreshold"
               (input)="onSliderChange($event)"
               class="similarity-slider">
        <div class="slider-labels">
          <span>0%</span>
          <span>25%</span>
          <span>50%</span>
          <span>75%</span>
          <span>100%</span>
        </div>
      </div>
      
      <div class="threshold-info">
        <div class="threshold-item" [style.color]="getSimilarityColor(1.0)">
          <span class="material-icons">check_circle</span>
          <span>100% - Mükemmel Eşleşme</span>
        </div>
        <div class="threshold-item" [style.color]="getSimilarityColor(0.85)">
          <span class="material-icons">star</span>
          <span>85%+ - Çok Yüksek Benzerlik</span>
        </div>
        <div class="threshold-item" [style.color]="getSimilarityColor(0.7)">
          <span class="material-icons">thumb_up</span>
          <span>70%+ - Yüksek Benzerlik</span>
        </div>
        <div class="threshold-item" [style.color]="getSimilarityColor(0.5)">
          <span class="material-icons">thumbs_up_down</span>
          <span>50%+ - Orta Benzerlik</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tablo -->
  <div class="table-container" *ngIf="songs && songs.length > 0">
    <table>
      <thead>
        <tr>
          <th class="status-col">Durum</th>
          <th>Dosya Yolu</th>
          <th *ngIf="hasUpdatedSongs()" class="actions-col">İşlemler</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let song of filteredSongs"
          [class.missing]="!song.isFileExists"
          [class.updated]="song.status === 'updated'"
        >
          <td class="status-col">
            <div class="status-container">
              <!-- Dosya durumu -->
              <span
                class="status-icon"
                [class.exists]="song.isFileExists"
                [class.missing]="!song.isFileExists"
                [class.updated]="song.status === 'updated'"
              >
                <span class="material-icons">
                  {{ getStatusIcon(song) }}
                </span>
              </span>

              <!-- Oynatma/Arama ikonları -->
              @if (song.isFileExists) {
                <button
                  class="status-icon"
                  [class.playing]="isPlaying(song)"
                  (click)="togglePlay(song)"
                  [attr.aria-label]="isPlaying(song) ? 'Durdur' : 'Oynat'"
                  tabindex="0"
                >
                  <span class="material-icons">
                    {{ isPlaying(song) ? "pause_circle" : "play_circle" }}
                  </span>
                </button>
              } @else {
                <button
                  class="status-icon search"
                  [class.searching]="song.isSearching"
                  [disabled]="song.isSearching"
                  (click)="searchSimilarFiles(song)"
                  aria-label="Alternatif Ara"
                  tabindex="0"
                >
                  <span class="material-icons">{{ song.isSearching ? "refresh" : "search" }}</span>
                </button>
              }
            </div>
          </td>
          <td class="path-col">
            <div class="path-container">
              <!-- Mevcut/Yeni Yol -->
              <div class="path-info">
                <div class="path-row">
                  <span [class.missing-text]="!song.isFileExists">
                    {{ song.status === "updated" ? song.newPath : song.filePath }}
                  </span>
                </div>
              </div>

              <!-- Orijinal Yol (güncellenmişse) -->
              @if (song.status === "updated" && song.originalPath) {
                <span class="original-path">
                  {{ song.originalPath }}
                </span>
              }

              <!-- Arama Bilgileri -->
              @if (song.searchInfo) {
                <div class="search-info">
                  <div class="search-info-header">
                    <span class="search-stage">{{ song.searchInfo.searchStage }}</span>
                    <span class="search-step">{{ song.searchInfo.searchStep }}. AŞAMA</span>
                  </div>
                  <div class="search-details">
                    <div class="search-detail">
                      <span class="label">Aranan:</span>
                      <span class="value">{{ song.searchInfo.searchedTerm || song.searchInfo.normalizedQuery }}</span>
                    </div>
                    <div class="search-detail">
                      <span class="label">Eşleşen Kelimeler:</span>
                      <span class="value">{{ song.searchInfo.matchedWords }}/{{ song.searchInfo.totalWords }}</span>
                    </div>
                    @if (song.searchInfo.bestMatchWords) {
                      <div class="search-detail">
                        <span class="label">En İyi Eşleşme:</span>
                        <span class="value">{{ song.searchInfo.bestMatchWords }}/{{ song.searchInfo.bestMatchTotalWords }} kelime</span>
                      </div>
                    }
                    @if (song.searchInfo.bestMatchSimilarity) {
                      <div class="search-detail">
                        <span class="label">Benzerlik Skoru:</span>
                        <span class="value">{{ (song.searchInfo.bestMatchSimilarity * 100) | number:'1.1-1' }}%</span>
                      </div>
                    }
                    @if (song.searchInfo.matchedWord) {
                      <div class="search-detail">
                        <span class="label">Bulunan Kelime:</span>
                        <span class="value">{{ song.searchInfo.matchedWord }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Benzer Dosyalar Tablosu -->
              @if (!song.isFileExists && song.similarFiles && song.similarFiles.length > 0) {
                <div class="similar-files">
                  <div class="similar-files-table">
                    @for (file of song.similarFiles; track file.path) {
                      <div class="similar-file-row">
                        <div class="file-info">
                          <span class="file-path">{{ file.path }}</span>
                          <div class="file-meta">
                            <span class="similarity">{{ file.similarity }}%</span>
                          </div>
                        </div>
                        <div class="file-actions">
                          <button
                            class="action-btn accept"
                            (click)="onSelectSimilarFile(song, file)"
                            title="Bu dosyayı kullan"
                          >
                            <span class="material-icons">check_circle</span>
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </td>
          <!-- İşlem Butonları -->
          @if (song.status === "updated") {
            <td class="actions-col">
              <div class="actions">
                <button
                  class="action-btn accept"
                  (click)="onAccept(song)"
                  title="Değişikliği Kabul Et"
                >
                  <span class="material-icons">check</span>
                </button>
                <button
                  class="action-btn reject"
                  (click)="onReject(song)"
                  title="Değişikliği Reddet"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            </td>
          }
        </tr>
      </tbody>
    </table>
  </div>
</div>
