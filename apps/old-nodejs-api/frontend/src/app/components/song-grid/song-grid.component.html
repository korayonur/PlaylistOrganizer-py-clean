<!-- ≈ûarkƒ± listesi -->
<div class="song-grid">
  <!-- Y√ºkleniyor -->
  <div *ngIf="loading()" class="loading-indicator">
    <span class="material-icons spin">refresh</span> Playlist i√ßeriƒüi y√ºkleniyor...
  </div>

  <!-- Tablo -->
  <div class="table-container" *ngIf="songs && songs.length > 0">
    <table>
      <thead>
        <tr>
          <th class="status-col">Durum</th>
          <th>Dosya Yolu</th>
          <th *ngIf="hasUpdatedSongs()" class="actions-col">ƒ∞≈ülemler</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let song of filteredSongs">
          <tr
            [class.missing]="!song.isFileExists"
            [class.updated]="song.status === 'updated'"
          >
          <td class="status-col">
            <div class="status-container">
              <!-- Dosya durumu -->
              <span
                class="status-icon"
                [class.exists]="song.isFileExists"
                [class.missing]="!song.isFileExists"
                [class.updated]="song.status === 'updated'"
              >
                <span class="material-icons">
                  {{ getStatusIcon(song) }}
                </span>
              </span>

              <!-- Oynatma/Arama ikonlarƒ± -->
              @if (song.isFileExists) {
                <button
                  class="status-icon"
                  [class.playing]="isPlaying(song)"
                  (click)="togglePlay(song)"
                  [attr.aria-label]="isPlaying(song) ? 'Durdur' : 'Oynat'"
                  tabindex="0"
                >
                  <span class="material-icons">
                    {{ isPlaying(song) ? "pause_circle" : "play_circle" }}
                  </span>
                </button>
              } @else {
                <button
                  class="status-icon search"
                  [class.searching]="song.isSearching"
                  [class.expanded]="expandedTrackPath === song.filePath"
                  [disabled]="song.isSearching"
                  (click)="searchForMissingTrack(song)"
                  aria-label="Alternatif Ara"
                  tabindex="0"
                >
                  <span class="material-icons">
                    {{ expandedTrackPath === song.filePath ? 'expand_less' : 'search' }}
                  </span>
                </button>
              }
            </div>
          </td>
          <td class="path-col">
            <div class="path-container">
              <!-- Mevcut/Yeni Yol -->
              <div class="path-info">
                <div class="path-row">
                  <span [class.missing-text]="!song.isFileExists">
                    {{ song.status === "updated" ? song.newPath : song.filePath }}
                  </span>
                </div>
              </div>

              <!-- Orijinal Yol (g√ºncellenmi≈üse) -->
              @if (song.status === "updated" && song.originalPath) {
                <span class="original-path">
                  {{ song.originalPath }}
                </span>
              }

              <!-- Arama Bilgileri -->
              @if (song.searchInfo) {
                <div class="search-info">
                  <div class="search-info-header">
                    <span class="search-stage">{{ song.searchInfo.searchStage }}</span>
                    <span class="search-step">{{ song.searchInfo.searchStep }}. A≈ûAMA</span>
                  </div>
                  <div class="search-details">
                    <div class="search-detail">
                      <span class="label">Aranan:</span>
                      <span class="value">{{ song.searchInfo.searchedTerm || song.searchInfo.normalizedQuery }}</span>
                    </div>
                    <div class="search-detail">
                      <span class="label">E≈üle≈üen Kelimeler:</span>
                      <span class="value">{{ song.searchInfo.matchedWords }}/{{ song.searchInfo.totalWords }}</span>
                    </div>
                    @if (song.searchInfo.bestMatchWords) {
                      <div class="search-detail">
                        <span class="label">En ƒ∞yi E≈üle≈üme:</span>
                        <span class="value">{{ song.searchInfo.bestMatchWords }}/{{ song.searchInfo.bestMatchTotalWords }} kelime</span>
                      </div>
                    }
                    @if (song.searchInfo.bestMatchSimilarity) {
                      <div class="search-detail">
                        <span class="label">Benzerlik Skoru:</span>
                        <span class="value">{{ (song.searchInfo.bestMatchSimilarity * 100) | number:'1.1-1' }}%</span>
                      </div>
                    }
                    @if (song.searchInfo.matchedWord) {
                      <div class="search-detail">
                        <span class="label">Bulunan Kelime:</span>
                        <span class="value">{{ song.searchInfo.matchedWord }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Benzer Dosyalar Tablosu -->
              @if (!song.isFileExists && song.similarFiles && song.similarFiles.length > 0) {
                <div class="similar-files">
                  <div class="similar-files-table">
                    @for (file of song.similarFiles; track file.path) {
                      <div class="similar-file-row">
                        <div class="file-info">
                          <span class="file-path">{{ file.path }}</span>
                          <div class="file-meta">
                            <span class="similarity">{{ file.similarity }}%</span>
                          </div>
                        </div>
                        <div class="file-actions">
                          <button
                            class="action-btn accept"
                            (click)="onSelectSimilarFile(song, file)"
                            title="Bu dosyayƒ± kullan"
                          >
                            <span class="material-icons">check_circle</span>
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </td>
          <!-- ƒ∞≈ülem Butonlarƒ± -->
          @if (song.status === "updated") {
            <td class="actions-col">
              <div class="actions">
                <button
                  class="action-btn accept"
                  (click)="onAccept(song)"
                  title="Deƒüi≈üikliƒüi Kabul Et"
                >
                  <span class="material-icons">check</span>
                </button>
                <button
                  class="action-btn reject"
                  (click)="onReject(song)"
                  title="Deƒüi≈üikliƒüi Reddet"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            </td>
          }
          </tr>

          <!-- Accordion expansion row -->
          <tr *ngIf="expandedTrackPath === song.filePath" class="expansion-row">
            <td colspan="2">
              <div class="search-result-panel">
                <!-- Loading -->
                <div *ngIf="searchResultForTrack.get(song.filePath)?.loading" class="loading-state">
                  <span class="material-icons spin">refresh</span>
                  üîç Aranƒ±yor...
                </div>

                <!-- Result found -->
                <div *ngIf="searchResultForTrack.get(song.filePath)?.result as result" class="result-card">
                  <div class="result-header">
                    <div class="header-info">
                      <strong>En ƒ∞yi E≈üle≈üme</strong>
                      <div class="result-path">{{ result.track_path }}</div>
                    </div>
                    <div class="score-chip">
                      <span class="label">Benzerlik</span>
                      <span class="value">{{ getResultScorePercent(result) | number:'1.0-0' }}%</span>
                    </div>
                  </div>

                  <div class="result-details">
                    <div class="detail-item full-width">
                      <span class="label">Dosya Adƒ±</span>
                      <span class="value">{{ result.fileName }}</span>
                    </div>
                    <div
                      class="detail-item"
                      [attr.title]="getMatchTooltip(song, result)"
                    >
                      <span class="label">E≈üle≈üen Kelimeler</span>
                      <span class="value match-count">
                        {{ result.match_count ?? getMatchedWords(song, result).length }}
                      </span>
                    </div>
                  </div>

                  <div
                    class="matched-words"
                    *ngIf="getMatchedWords(song, result).length > 0"
                  >
                    <span class="label">Kelimeler</span>
                    <div class="word-list">
                      <span
                        class="word-chip"
                        *ngFor="let word of getMatchedWords(song, result); trackBy: trackByWord"
                      >
                        {{ word }}
                      </span>
                    </div>
                  </div>

                  <div class="result-actions">
                    <button
                      type="button"
                      class="play-btn"
                      [class.playing]="isPreviewPlaying(song, result.track_path)"
                      (click)="togglePreviewTrack(song, result.track_path)"
                      [disabled]="fixLoadingForTrack.get(song.filePath)"
                      title="E≈üle≈ümeyi Dinle"
                    >
                      <span class="material-icons">
                        {{ isPreviewPlaying(song, result.track_path) ? 'pause_circle' : 'play_circle' }}
                      </span>
                      <span class="button-text">
                        {{ isPreviewPlaying(song, result.track_path) ? 'Durdur' : 'Dinle' }}
                      </span>
                    </button>
                    <button
                      type="button"
                      class="fix-btn"
                      [disabled]="fixLoadingForTrack.get(song.filePath)"
                      (click)="fixTrack(song, result.track_path)"
                    >
                      <span class="material-icons">healing</span>
                      {{ fixLoadingForTrack.get(song.filePath) ? 'D√ºzeltiliyor...' : 'Fix' }}
                    </button>
                  </div>
                </div>

                <!-- Not found -->
                <div
                  *ngIf="searchResultForTrack.get(song.filePath)?.success === true && !searchResultForTrack.get(song.filePath)?.result"
                  class="no-result"
                >
                  <span class="material-icons">search_off</span>
                  ‚ùå Benzer dosya bulunamadƒ±
                </div>

                <!-- Error -->
                <div *ngIf="searchResultForTrack.get(song.filePath)?.error" class="error-state">
                  <span class="material-icons">error</span>
                  {{ searchResultForTrack.get(song.filePath)?.error }}
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>
